<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>map demo</title>
    <link rel="stylesheet" href="js/lib/ol4.6.4/ol.css" type="text/css">
    <link rel="stylesheet" href="css/demo20.css" type="text/css">
</head>
<body>
<div id="map">
    <div class="query-box">
        <table cellspacing="0" cellpadding="0">
            <tr>
                <th width=40">名称</th>
                <td>
                    <input id="name" type="text" placeholder="请输入大学名称..." style="width: 185px;">
                    <input type="button" value="查询" style="float: right;">
                </td>
            </tr>
            <tr>
                <th>所属地</th>
                <td class="province">
                    <span class="active">全部</span>
                </td>
            </tr>
            <tr>
                <th>等级</th>
                <td class="level">
                    <span class="active">全部</span>
                    <span>本科</span>
                    <span>专科</span>
                </td>
            </tr>
            <tr>
                <th>类型</th>
                <td class="isprivate">
                    <span class="active">全部</span>
                    <span>公办</span>
                    <span>民办</span>
                </td>
            </tr>
        </table>
    </div>
</div>
<script src="js/lib/ol4.6.4/ol.js"></script>
<script src="js/lib/jquery/jquery-3.3.1.min.js"></script>
<script>
  var map, provinces = [];
  var base = getTilelayer("midnight");

  var source = new ol.source.Vector({
    features: []
  });
  var vector = new ol.layer.Vector({
    source: source,
    style: function (feat) {
      var name = map.getView().getZoom()>10?feat.get("attr").name:"";
      return new ol.style.Style({
        image: new ol.style.Circle({
          radius: 4,
          fill: new ol.style.Fill({
            color: '#ff0000'
          })
        }),
        text: new ol.style.Text({
          text:name,
          fill: new ol.style.Fill({
            color: '#ffffff'
          }),
          textAlign:"left",
          offsetX:"6",
          stroke: new ol.style.Stroke({
            color: '#d7d7d7',
            width: 1
          })
        })
      })
    }
  });

  map = new ol.Map({
    controls: ol.control.defaults({
      attribution: false
    }),
    target: 'map',
    layers: [base, vector],
    view: new ol.View({
      center: ol.proj.fromLonLat([98.633, 31.607]),
      zoom:4,
      minZoom:0,
      maxZoom:18
    })
  });

  showUniversity();

  function showUniversity() {
    var url = "test/university";
    var name = $("#name").val(),
      level = $($("td.level").find("span.active")[0]).html(),
      province = $($("td.province").find("span.active")[0]).html(),
      isprivate = $($("td.isprivate").find("span.active")[0]).html();
    level = level==="全部"?"":level;
    province = province==="全部"?"":province;
    isprivate = isprivate==="全部"?"":isprivate;

    var paras = {
      name:name,
      level:level,
      province:province,
      isprivate:isprivate
    };

    $.get(url, paras, function (result) {
      var _provinces = {};
      var undo = provinces.length===0;
      source.clear();
      var features = [];
      for(var i=0;i<result.length;i++){
        var _r = result[i];
        var coord = ol.proj.fromLonLat([_r.lon, _r.lat]);
        features.push(new ol.Feature({
          geometry: new ol.geom.Point(coord),
          attr: _r
        }));

        if(!_provinces[_r.province]) {
          _provinces[_r.province] = 1;
          if(undo) provinces.push(_r.province);
        }
      }
      source.addFeatures(features);
      if(undo) {
        for(var i=0;i<provinces.length;i++){
          $("td.province").append($("<span/>").html(provinces[i]));
        }
      }
    })
  }

  function getTilelayer(lyr){
    var url = "https://s{0-8}.geohey.com/s/mapping/"+lyr+"/all?z={z}&x={x}&y={y}&retina=&ak=MGUxMmI2ZTk4YTVhNDEzYmJhZDJkNDM3ZWI5ZDAwOGE";
    var layer = new ol.layer.Tile({
      source: new ol.source.XYZ({
        url:url
      })
    });
    return layer;
  }
</script>
</body>
</html>